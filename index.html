<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Art Background Remover</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 40px;
            max-width: 900px;
            width: 100%;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header h1 {
            color: #333;
            font-size: 2.5em;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header p {
            color: #666;
            font-size: 1em;
        }

        .content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .section {
            display: flex;
            flex-direction: column;
        }

        .section-title {
            color: #333;
            font-weight: 600;
            margin-bottom: 15px;
            font-size: 1.1em;
        }

        .drop-zone {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 50px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f8f9ff;
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 300px;
        }

        .drop-zone:hover,
        .drop-zone.dragover {
            border-color: #764ba2;
            background: #f0e6ff;
            transform: scale(1.02);
        }

        .drop-zone-icon {
            font-size: 3em;
            margin-bottom: 15px;
        }

        .drop-zone-text {
            color: #333;
            font-size: 1.1em;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .drop-zone-subtext {
            color: #999;
            font-size: 0.9em;
        }

        .image-preview {
            border-radius: 15px;
            background: #f8f9ff;
            padding: 15px;
            display: flex;
            justify-content: center;
            align-items: center;
            flex: 1;
            min-height: 300px;
            overflow: hidden;
        }

        .image-preview img,
        .image-preview canvas {
            max-width: 100%;
            max-height: 100%;
            border-radius: 10px;
        }

        .button-group {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
        }

        .btn {
            flex: 1;
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-file {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-file:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }

        .btn-folder {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .btn-folder:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(245, 87, 108, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        input[type="file"] {
            display: none;
        }

        .settings-panel {
            background: #f8f9ff;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
        }

        .setting-item {
            margin-bottom: 20px;
        }

        .setting-item:last-child {
            margin-bottom: 0;
        }

        .setting-item label {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #333;
            font-size: 0.95em;
            margin-bottom: 8px;
            cursor: pointer;
            font-weight: 600;
        }

        .color-input-group {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-top: 10px;
        }

        .color-picker {
            width: 50px;
            height: 50px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .color-picker:hover {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .color-label {
            flex: 1;
            color: #666;
            font-size: 0.9em;
        }

        input[type="text"],
        input[type="number"],
        select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s ease;
            font-family: inherit;
            margin-top: 8px;
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .slider-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }

        input[type="range"] {
            flex: 1;
            height: 6px;
            border-radius: 3px;
            background: #e0e0e0;
            outline: none;
            -webkit-appearance: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.4);
        }

        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.4);
        }

        .slider-value {
            min-width: 50px;
            text-align: center;
            color: #667eea;
            font-weight: 600;
        }

        .file-list {
            background: #f8f9ff;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
            max-height: 250px;
            overflow-y: auto;
        }

        .file-list-title {
            color: #333;
            font-weight: 600;
            margin-bottom: 12px;
            font-size: 0.95em;
        }

        .file-item {
            background: white;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 4px solid #667eea;
        }

        .file-item:last-child {
            margin-bottom: 0;
        }

        .file-name {
            flex: 1;
            color: #333;
            font-size: 0.9em;
            word-break: break-all;
        }

        .file-remove {
            background: #ff6b6b;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85em;
            transition: all 0.3s ease;
        }

        .file-remove:hover {
            background: #ee5a52;
            transform: scale(1.05);
        }

        .button-wrapper {
            display: flex;
            gap: 15px;
        }

        .process-btn,
        .download-btn,
        .reset-btn {
            flex: 1;
            padding: 14px 20px;
            border: none;
            border-radius: 10px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .process-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .process-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }

        .process-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .download-btn {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }

        .download-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(17, 153, 142, 0.4);
        }

        .download-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .reset-btn {
            background: #e0e0e0;
            color: #333;
        }

        .reset-btn:hover {
            background: #d0d0d0;
            transform: translateY(-2px);
        }

        .progress-container {
            margin-bottom: 20px;
            display: none;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.3s ease;
        }

        .progress-text {
            text-align: center;
            color: #666;
            font-size: 0.9em;
        }

        /* Notification Styles */
        .notification {
            position: fixed;
            top: 30px;
            right: 30px;
            background: white;
            padding: 20px 25px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            display: none;
            align-items: center;
            gap: 15px;
            animation: slideIn 0.3s ease;
            z-index: 1000;
            max-width: 400px;
        }

        .notification.show {
            display: flex;
        }

        .notification.success {
            border-left: 4px solid #4caf50;
        }

        .notification.error {
            border-left: 4px solid #f44336;
        }

        .notification.info {
            border-left: 4px solid #2196f3;
        }

        .notification.warning {
            border-left: 4px solid #ff9800;
        }

        .notification-icon {
            font-size: 1.5em;
            flex-shrink: 0;
        }

        .notification.success .notification-icon {
            color: #4caf50;
        }

        .notification.error .notification-icon {
            color: #f44336;
        }

        .notification.info .notification-icon {
            color: #2196f3;
        }

        .notification.warning .notification-icon {
            color: #ff9800;
        }

        .notification-content {
            flex: 1;
        }

        .notification-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 3px;
        }

        .notification-message {
            color: #666;
            font-size: 0.9em;
        }

        .notification-close {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: #999;
            transition: color 0.3s ease;
            flex-shrink: 0;
        }

        .notification-close:hover {
            color: #333;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }

        .notification.hide {
            animation: slideOut 0.3s ease forwards;
        }

        .preview-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
            display: none;
        }

        .preview-item {
            text-align: center;
        }

        .preview-label {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 10px;
            font-weight: 600;
        }

        /* Responsive Design */
        @media (max-width: 900px) {
            .content {
                grid-template-columns: 1fr;
            }

            .button-wrapper {
                flex-direction: column;
            }
        }

        @media (max-width: 600px) {
            .container {
                padding: 25px;
            }

            .header h1 {
                font-size: 1.8em;
            }

            .drop-zone {
                padding: 30px 15px;
            }

            .button-group {
                flex-direction: column;
            }

            .notification {
                right: 15px;
                left: 15px;
                max-width: none;
            }

            .settings-panel {
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üé® Art Background Remover</h1>
            <p>Remove backgrounds from images with Art BgRemover</p>
        </div>

        <div class="button-group">
            <button class="btn btn-file" id="fileBtn">
                üìÑ Choose Files
            </button>
            <button class="btn btn-folder" id="folderBtn">
                üìÇ Choose Folder
            </button>
        </div>

        <div class="content">
            <!-- Upload Section -->
            <div class="section">
                <div class="section-title">üì• Upload Images</div>
                <div class="drop-zone" id="dropZone">
                    <div class="drop-zone-icon">üì∏</div>
                    <div class="drop-zone-text">Drop images here</div>
                    <div class="drop-zone-subtext">Supported: JPG, PNG, GIF, WebP</div>
                </div>
            </div>

            <!-- Preview Section -->
            <div class="section">
                <div class="section-title">üëÅÔ∏è Preview</div>
                <div class="image-preview" id="imagePreview">
                    <div style="color: #999; text-align: center;">
                        <div style="font-size: 2em; margin-bottom: 10px;">üì∑</div>
                        <div>Image preview will appear here</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- File List -->
        <div class="file-list" id="fileList" style="display: none;">
            <div class="file-list-title">üìã Selected Files</div>
            <div id="fileItems"></div>
        </div>

        <!-- Settings Panel -->
        <div class="settings-panel">
            <div class="setting-item">
                <label>
                    <input type="radio" name="bg-mode" value="transparent" checked>
                    <span>üî≤ Transparent Background</span>
                </label>
            </div>

            <div class="setting-item">
                <label>
                    <input type="radio" name="bg-mode" value="color">
                    <span>üé® Custom Color Background</span>
                </label>
                <div class="color-input-group" id="colorInput" style="opacity: 0.5;">
                    <input type="color" id="bgColor" class="color-picker" value="#ffffff">
                    <div class="color-label" id="colorLabel">#FFFFFF</div>
                </div>
            </div>

            <div class="setting-item">
                <label>
                    <input type="radio" name="bg-mode" value="gradient">
                    <span>üåà Gradient Background</span>
                </label>
                <div class="color-input-group" id="gradientInput" style="opacity: 0.5;">
                    <input type="color" id="gradientColor1" class="color-picker" value="#667eea">
                    <span style="color: #999;">to</span>
                    <input type="color" id="gradientColor2" class="color-picker" value="#764ba2">
                </div>
            </div>

            <div class="setting-item" style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #e0e0e0;">
                <label>üéØ Detection Sensitivity</label>
                <div class="slider-container">
                    <span style="font-size: 0.9em; color: #666;">Low</span>
                    <input type="range" id="sensitivityRange" min="1" max="100" value="60">
                    <span class="slider-value" id="sensitivityValue">60</span>
                    <span style="font-size: 0.9em; color: #666;">High</span>
                </div>
            </div>

            <div class="setting-item" style="margin-top: 15px;">
                <label>
                    <input type="checkbox" id="renameCheck" checked>
                    <span>Add "bg_removed" suffix to filename</span>
                </label>
            </div>

            <div class="setting-item" style="margin-top: 15px;">
                <label>
                    <input type="checkbox" id="autoDownloadCheck" checked>
                    <span>Auto download processed images</span>
                </label>
            </div>
        </div>

        <!-- Progress Bar -->
        <div class="progress-container" id="progressContainer">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="progress-text" id="progressText">Processing...</div>
        </div>

        <!-- Action Buttons -->
        <div class="button-wrapper">
            <button class="process-btn" id="processBtn" disabled>
                ‚ú® Remove Background
            </button>
            <button class="download-btn" id="downloadBtn" disabled>
                ‚¨áÔ∏è Download All
            </button>
            <button class="reset-btn" id="resetBtn">
                üîÑ Reset
            </button>
        </div>
    </div>

    <!-- Hidden File Inputs -->
    <input type="file" id="fileInput" multiple accept="image/*">
    <input type="file" id="folderInput" webkitdirectory directory accept="image/*">

    <!-- Notification -->
    <div class="notification" id="notification">
        <div class="notification-icon" id="notificationIcon">‚úì</div>
        <div class="notification-content">
            <div class="notification-title" id="notificationTitle">Success</div>
            <div class="notification-message" id="notificationMessage">Background removed successfully!</div>
        </div>
        <button class="notification-close" id="notificationClose">‚úï</button>
    </div>

    <script>
        // DOM Elements
        const fileInput = document.getElementById('fileInput');
        const folderInput = document.getElementById('folderInput');
        const fileBtn = document.getElementById('fileBtn');
        const folderBtn = document.getElementById('folderBtn');
        const dropZone = document.getElementById('dropZone');
        const processBtn = document.getElementById('processBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const resetBtn = document.getElementById('resetBtn');
        const fileList = document.getElementById('fileList');
        const fileItems = document.getElementById('fileItems');
        const imagePreview = document.getElementById('imagePreview');
        const progressContainer = document.getElementById('progressContainer');
        const progressFill = document.getElementById('progressFill');
        const progressText = document.getElementById('progressText');

        // Settings Elements
        const bgModeRadios = document.querySelectorAll('input[name="bg-mode"]');
        const colorInput = document.getElementById('colorInput');
        const gradientInput = document.getElementById('gradientInput');
        const bgColor = document.getElementById('bgColor');
        const colorLabel = document.getElementById('colorLabel');
        const gradientColor1 = document.getElementById('gradientColor1');
        const gradientColor2 = document.getElementById('gradientColor2');
        const sensitivityRange = document.getElementById('sensitivityRange');
        const sensitivityValue = document.getElementById('sensitivityValue');
        const renameCheck = document.getElementById('renameCheck');
        const autoDownloadCheck = document.getElementById('autoDownloadCheck');

        // Notification Elements
        const notification = document.getElementById('notification');
        const notificationIcon = document.getElementById('notificationIcon');
        const notificationTitle = document.getElementById('notificationTitle');
        const notificationMessage = document.getElementById('notificationMessage');
        const notificationClose = document.getElementById('notificationClose');

        let selectedFiles = [];
        let processedImages = [];

        // Button Events
        fileBtn.addEventListener('click', () => fileInput.click());
        folderBtn.addEventListener('click', () => folderInput.click());

        // File Input Events
        fileInput.addEventListener('change', (e) => {
            selectedFiles = Array.from(e.target.files).filter(file => file.type.startsWith('image/'));
            updateFileList();
        });

        folderInput.addEventListener('change', (e) => {
            selectedFiles = Array.from(e.target.files).filter(file => file.type.startsWith('image/'));
            updateFileList();
        });

        // Drag and Drop
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('dragover');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            
            const items = Array.from(e.dataTransfer.items);
            const files = [];

            Promise.all(items.map(item => {
                if (item.kind === 'file') {
                    const entry = item.webkitGetAsEntry();
                    if (entry.isDirectory) {
                        return getAllFilesFromDirectory(entry);
                    } else {
                        const file = item.getAsFile();
                        return file.type.startsWith('image/') ? Promise.resolve([file]) : Promise.resolve([]);
                    }
                }
                return Promise.resolve([]);
            })).then(results => {
                selectedFiles = results.flat().filter(file => file !== null);
                updateFileList();
            });
        });

        // Get all files from directory
        function getAllFilesFromDirectory(directoryReader) {
            return new Promise((resolve) => {
                const files = [];
                
                function readEntries(reader) {
                    reader.readEntries((entries) => {
                        if (entries.length === 0) {
                            resolve(files);
                        } else {
                            entries.forEach((entry) => {
                                if (entry.isDirectory) {
                                    readEntries(entry.createReader());
                                } else {
                                    entry.file((file) => {
                                        if (file.type.startsWith('image/')) {
                                            files.push(file);
                                        }
                                    });
                                }
                            });
                            readEntries(reader);
                        }
                    });
                }
                
                readEntries(directoryReader.createReader());
            });
        }

        // Update file list
        function updateFileList() {
            if (selectedFiles.length === 0) {
                fileList.style.display = 'none';
                processBtn.disabled = true;
                downloadBtn.disabled = true;
                return;
            }

            fileList.style.display = 'block';
            processBtn.disabled = false;
            fileItems.innerHTML = '';

            selectedFiles.forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.innerHTML = `
                    <div class="file-name">${file.name}</div>
                    <button class="file-remove" onclick="removeFile(${index})">Remove</button>
                `;
                fileItems.appendChild(fileItem);
            });
        }

        // Remove file
        window.removeFile = function(index) {
            selectedFiles.splice(index, 1);
            updateFileList();
        };

        // Background mode change
        bgModeRadios.forEach(radio => {
            radio.addEventListener('change', (e) => {
                if (e.target.value === 'transparent') {
                    colorInput.style.opacity = '0.5';
                    gradientInput.style.opacity = '0.5';
                    colorInput.querySelectorAll('input').forEach(el => el.disabled = true);
                    gradientInput.querySelectorAll('input').forEach(el => el.disabled = true);
                } else if (e.target.value === 'color') {
                    colorInput.style.opacity = '1';
                    gradientInput.style.opacity = '0.5';
                    colorInput.querySelectorAll('input').forEach(el => el.disabled = false);
                    gradientInput.querySelectorAll('input').forEach(el => el.disabled = true);
                } else if (e.target.value === 'gradient') {
                    colorInput.style.opacity = '0.5';
                    gradientInput.style.opacity = '1';
                    colorInput.querySelectorAll('input').forEach(el => el.disabled = true);
                    gradientInput.querySelectorAll('input').forEach(el => el.disabled = false);
                }
            });
        });

        // Color picker
        bgColor.addEventListener('change', (e) => {
            colorLabel.textContent = e.target.value.toUpperCase();
        });

        bgColor.addEventListener('input', (e) => {
            colorLabel.textContent = e.target.value.toUpperCase();
        });

        // Sensitivity slider
        sensitivityRange.addEventListener('input', (e) => {
            sensitivityValue.textContent = e.target.value;
        });

        // Process button
        processBtn.addEventListener('click', () => {
            if (selectedFiles.length === 0) {
                showNotification('error', 'No Files', 'Please select images to process');
                return;
            }
            processImages();
        });

        // Download button
        downloadBtn.addEventListener('click', () => {
            if (processedImages.length === 0) {
                showNotification('error', 'No Images', 'Please process images first');
                return;
            }
            downloadAllImages();
        });

        // Reset button
        resetBtn.addEventListener('click', () => {
            selectedFiles = [];
            processedImages = [];
            updateFileList();
            imagePreview.innerHTML = `
                <div style="color: #999; text-align: center;">
                    <div style="font-size: 2em; margin-bottom: 10px;">üì∑</div>
                    <div>Image preview will appear here</div>
                </div>
            `;
            downloadBtn.disabled = true;
            fileInput.value = '';
            folderInput.value = '';
            showNotification('info', 'Reset', 'All data cleared');
        });

        // Main processing function
        async function processImages() {
            processBtn.disabled = true;
            progressContainer.style.display = 'block';
            processedImages = [];

            const bgMode = document.querySelector('input[name="bg-mode"]:checked').value;
            const sensitivity = parseInt(sensitivityRange.value);
            const shouldRename = renameCheck.checked;
            const shouldAutoDownload = autoDownloadCheck.checked;

            let completed = 0;

            for (let file of selectedFiles) {
                try {
                    // Load image
                    const imageData = await loadImage(file);
                    
                    // Remove background
                    const processedCanvas = await removeBackground(imageData, sensitivity, bgMode);
                    
                    // Convert to blob
                    const blob = await canvasToBlob(processedCanvas);
                    
                    // Generate filename
                    const newFileName = shouldRename ? generateFileName(file.name) : file.name;
                    
                    // Store for download
                    processedImages.push({ blob, name: newFileName });
                    
                    // Auto download if enabled
                    if (shouldAutoDownload) {
                        downloadFile(blob, newFileName);
                    }

                    // Show preview of first image
                    if (completed === 0) {
                        imagePreview.innerHTML = '';
                        const img = new Image();
                        img.src = URL.createObjectURL(blob);
                        imagePreview.appendChild(img);
                    }

                    completed++;
                    const progress = Math.round((completed / selectedFiles.length) * 100);
                    progressFill.style.width = progress + '%';
                    progressText.textContent = `Processing... ${progress}% (${completed}/${selectedFiles.length})`;

                } catch (error) {
                    console.error('Processing error:', error);
                    showNotification('error', 'Error', `Failed to process ${file.name}`);
                }
            }

            progressContainer.style.display = 'none';
            processBtn.disabled = false;
            downloadBtn.disabled = false;

            showNotification('success', '‚ú® Success!', 
                `${completed} image(s) processed! Background removed successfully. ${shouldAutoDownload ? 'Downloads started.' : 'Click download to get your images.'}`);
        }

        // Load image
        function loadImage(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        canvas.width = img.width;
                        canvas.height = img.height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0);
                        resolve(canvas);
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }

        // Remove background using color detection
        async function removeBackground(canvas, sensitivity, bgMode) {
            const ctx = canvas.getContext('2d');
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;

            // Create new canvas for output
            const outputCanvas = document.createElement('canvas');
            outputCanvas.width = canvas.width;
            outputCanvas.height = canvas.height;
            const outputCtx = outputCanvas.getContext('2d');

            // Determine background color (most common color)
            const bgColorData = getBackgroundColor(data);
            
            // Threshold for color similarity
            const threshold = (100 - sensitivity) * 2.55;

            // Create mask
            const outputImageData = outputCtx.createImageData(canvas.width, canvas.height);
            const outputData = outputImageData.data;

            for (let i = 0; i < data.length; i += 4) {
                const r = data[i];
                const g = data[i + 1];
                const b = data[i + 2];

                // Calculate color difference
                const diff = Math.sqrt(
                    Math.pow(r - bgColorData.r, 2) +
                    Math.pow(g - bgColorData.g, 2) +
                    Math.pow(b - bgColorData.b, 2)
                );

                if (diff < threshold) {
                    // Background - make transparent or fill with selected color
                    if (bgMode === 'transparent') {
                        outputData[i + 3] = 0; // Transparent
                    } else if (bgMode === 'color') {
                        const colorValue = bgColor.value;
                        const rgb = hexToRgb(colorValue);
                        outputData[i] = rgb.r;
                        outputData[i + 1] = rgb.g;
                        outputData[i + 2] = rgb.b;
                        outputData[i + 3] = 255;
                    } else if (bgMode === 'gradient') {
                        // Gradient background - simple linear gradient
                        const gradient = Math.floor((i / 4) / canvas.width / canvas.height * 255);
                        const rgb1 = hexToRgb(gradientColor1.value);
                        const rgb2 = hexToRgb(gradientColor2.value);
                        outputData[i] = Math.floor(rgb1.r + (rgb2.r - rgb1.r) * (gradient / 255));
                        outputData[i + 1] = Math.floor(rgb1.g + (rgb2.g - rgb1.g) * (gradient / 255));
                        outputData[i + 2] = Math.floor(rgb1.b + (rgb2.b - rgb1.b) * (gradient / 255));
                        outputData[i + 3] = 255;
                    }
                } else {
                    // Foreground - keep original
                    outputData[i] = r;
                    outputData[i + 1] = g;
                    outputData[i + 2] = b;
                    outputData[i + 3] = data[i + 3];
                }
            }

            outputCtx.putImageData(outputImageData, 0, 0);
            return outputCanvas;
        }

        // Get background color (most common color in image)
        function getBackgroundColor(data) {
            const colorMap = {};
            let maxColor = { r: 255, g: 255, b: 255, count: 0 };

            // Sample every 10th pixel for performance
            for (let i = 0; i < data.length; i += 40) {
                const r = data[i];
                const g = data[i + 1];
                const b = data[i + 2];
                const key = `${r},${g},${b}`;

                colorMap[key] = (colorMap[key] || 0) + 1;
                if (colorMap[key] > maxColor.count) {
                    maxColor = { r, g, b, count: colorMap[key] };
                }
            }

            return maxColor;
        }

        // Hex to RGB
        function hexToRgb(hex) {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? {
                r: parseInt(result[1], 16),
                g: parseInt(result[2], 16),
                b: parseInt(result[3], 16)
            } : { r: 255, g: 255, b: 255 };
        }

        // Canvas to Blob
        function canvasToBlob(canvas) {
            return new Promise((resolve) => {
                canvas.toBlob((blob) => {
                    resolve(blob);
                }, 'image/png');
            });
        }

        // Generate filename
        function generateFileName(originalName) {
            const parts = originalName.split('.');
            const extension = parts.pop();
            const baseName = parts.join('.');
            return `${baseName}_bg_removed.${extension}`;
        }

        // Download single file
        function downloadFile(blob, fileName) {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Download all images
        function downloadAllImages() {
            processedImages.forEach(img => {
                setTimeout(() => {
                    downloadFile(img.blob, img.name);
                }, 200);
            });
        }

        // Show notification
        function showNotification(type, title, message) {
            notificationTitle.textContent = title;
            notificationMessage.textContent = message;
            
            notification.classList.remove('success', 'error', 'info', 'warning', 'hide');
            notification.classList.add(type, 'show');

            if (type === 'success') {
                notificationIcon.textContent = '‚úì';
            } else if (type === 'error') {
                notificationIcon.textContent = '‚úï';
            } else if (type === 'warning') {
                notificationIcon.textContent = '‚ö†';
            } else {
                notificationIcon.textContent = '‚Ñπ';
            }

            // Auto-hide after 6 seconds
            setTimeout(() => {
                notification.classList.add('hide');
                setTimeout(() => {
                    notification.classList.remove('show');
                }, 300);
            }, 6000);
        }

        // Notification close
        notificationClose.addEventListener('click', () => {
            notification.classList.add('hide');
            setTimeout(() => {
                notification.classList.remove('show');
            }, 300);
        });
    </script>
</body>
</html>
